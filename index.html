<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Boy Camera</title>
    <meta name="description" content="Game Boy Camera Simulator">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiR2FtZSBCb3kgQ2FtZXJhIiwic2hvcnRfbmFtZSI6IkdCQ2FtZXJhIiwiZGVzY3JpcHRpb24iOiJHYW1lIEJveSBDYW1lcmEgU2ltdWxhdG9yIiwic3RhcnRfdXJsIjoiLi8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjOUJCQzBGIiwidGhlbWVfY29sb3IiOiIjOUJCQzBGIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBQmdBQUFBUUNBWUFBQUNnSmZDWkFBQUFCSE5DU1ZRSUNBZ0lmQWhraUFBQUFDWEJJV1hNQUFCWWxBQUFXSlFGSlVpVHdBQUFBSlhSRldIUmtZWFJsT21OeVpXRjBaUUF5TURFekxUQXpMVEU1VkRFek9qVXhPak0zS3pBd01EQXdmRHR4QUFBQUkybEVXSFJrWVhSbE9tTnlaV0YwWlFBeU1ERXpMVEF6TFRFNVZERXpPalV4T2pNM0t6QXdNREF3SDhISkFBQUFIa2xFUVZRNHkyTmdBQUpDUUJCTUFjamVtenAxQUFBQUFFbEZUa1N1UW1DQyIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9wbmcifV19">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #9BBC0F;
            color: #0F380F;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            padding: 10px;
        }

        .gameboy-frame {
            background: #9BBC0F;
            border: 8px solid #8BAC0F;
            border-radius: 15px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            box-shadow: inset -4px -4px 0px #306230, inset 4px 4px 0px #9BBC0F;
        }

        .screen-container {
            background: #0F380F;
            border: 4px solid #0F380F;
            border-radius: 8px;
            padding: 8px;
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .screen {
            background: #9BBC0F;
            border: 2px solid #306230;
            flex: 1;
            position: relative;
            overflow: hidden;
            image-rendering: pixelated;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .viewfinder {
            width: 160px;
            height: 144px;
            background: #9BBC0F;
            border: 1px solid #306230;
            position: relative;
            image-rendering: pixelated;
            margin: 0 auto;
        }

        #video {
            display: none;
        }

        #preview-canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: crisp-edges;
        }

        #canvas {
            display: none;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
            padding: 0 10px;
            gap: 15px;
        }

        .button {
            background: #306230;
            color: #9BBC0F;
            border: none;
            border-radius: 20px;
            padding: 12px 20px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            box-shadow: 2px 2px 0px #0F380F;
            transition: all 0.1s;
            text-transform: uppercase;
        }

        .button:active {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0px #0F380F;
        }

        .button:hover {
            background: #0F380F;
        }

        .button.danger {
            background: #8B0000;
            color: #FFB6C1;
        }

        .button.danger:hover {
            background: #660000;
        }

        .status-bar {
            background: #0F380F;
            color: #9BBC0F;
            padding: 5px 10px;
            font-size: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .filter-controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .filter-btn {
            background: #8BAC0F;
            color: #0F380F;
            border: 1px solid #306230;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 10px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }

        .filter-btn.active {
            background: #306230;
            color: #9BBC0F;
        }

        .photo-gallery {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 56, 15, 0.9);
            display: none;
            padding: 20px;
            overflow-y: auto;
            z-index: 1000;
        }

        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            position: relative;
        }

        .gallery-title {
            color: #9BBC0F;
            font-size: 18px;
            font-weight: bold;
            flex: 1;
        }

        .close-gallery-x {
            position: absolute;
            top: -10px;
            right: 0;
            background: #306230;
            color: #9BBC0F;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 2px 2px 0px #0F380F;
            transition: all 0.1s;
        }

        .close-gallery-x:hover {
            background: #0F380F;
        }

        .close-gallery-x:active {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0px #0F380F;
        }

        .gallery-controls {
            display: flex;
            gap: 10px;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            max-width: 800px;
            margin: 0 auto;
        }

        .gallery-photo {
            background: #9BBC0F;
            border: 2px solid #306230;
            border-radius: 4px;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
        }

        .gallery-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            image-rendering: pixelated;
        }

        .clear-gallery {
            background: #8B0000;
            color: #FFB6C1;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 12px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
        }

        .clear-gallery:hover {
            background: #660000;
        }

        .pixelate {
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        .confirm-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #9BBC0F;
            border: 4px solid #306230;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            z-index: 1002;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            display: none;
        }

        .confirm-dialog h3 {
            color: #0F380F;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .confirm-btn {
            background: #306230;
            color: #9BBC0F;
            border: none;
            border-radius: 15px;
            padding: 8px 16px;
            font-size: 10px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
        }

        .confirm-btn.danger {
            background: #8B0000;
            color: #FFB6C1;
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .gameboy-frame {
                max-width: 100%;
                padding: 15px;
                border-width: 4px;
            }
            
            .controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .gallery-controls {
                flex-direction: column;
                gap: 5px;
            }
            
            .viewfinder {
                width: 140px;
                height: 126px;
            }
        }
    </style>
</head>
<body>
    <div class="gameboy-frame">
        <div class="screen-container">
            <div class="status-bar">
                <span>GAME BOY CAMERA</span>
                <span id="photo-count">000</span>
            </div>
            <div class="screen">
                <div class="viewfinder">
                    <video id="video" class="pixelate" autoplay playsinline></video>
                    <canvas id="preview-canvas" class="pixelate"></canvas>
                    <canvas id="canvas"></canvas>
                </div>
            </div>
            <div class="filter-controls">
                <button class="filter-btn active" data-filter="normal">NORMAL</button>
                <button class="filter-btn" data-filter="contrast">CONTRAST</button>
                <button class="filter-btn" data-filter="invert">INVERT</button>
                <button class="filter-btn" data-filter="blur">MOTION</button>
            </div>
        </div>
        
        <div class="controls">
            <button class="button" id="capture-btn">CAPTURE</button>
            <button class="button" id="gallery-btn">GALLERY</button>
        </div>
    </div>

    <div class="photo-gallery" id="gallery">
        <div class="gallery-header">
            <div class="gallery-title">SAVED PHOTOS</div>
            <button class="close-gallery-x" id="close-gallery">Ã—</button>
            <div class="gallery-controls">
                <button class="clear-gallery" id="clear-gallery">DELETE ALL</button>
            </div>
        </div>
        <div class="gallery-grid" id="gallery-grid">
        </div>
    </div>

    <div class="confirm-dialog" id="confirm-dialog">
        <h3>Delete all photos?</h3>
        <div class="confirm-buttons">
            <button class="confirm-btn" id="confirm-cancel">CANCEL</button>
            <button class="confirm-btn danger" id="confirm-delete">DELETE</button>
        </div>
    </div>

    <script>
        class GameBoyCamera {
            constructor() {
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.previewCanvas = document.getElementById('preview-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.previewCtx = this.previewCanvas.getContext('2d');
                this.photos = [];
                this.currentFilter = 'normal';
                this.animationId = null;
                
                // Create a stable dithering matrix for consistent preview
                this.ditherMatrix = this.generateStableDitherMatrix(160, 144);
                
                this.loadPhotos();
                this.init();
            }

            generateStableDitherMatrix(width, height) {
                const matrix = [];
                for (let y = 0; y < height; y++) {
                    matrix[y] = [];
                    for (let x = 0; x < width; x++) {
                        // Use a deterministic pattern based on position
                        matrix[y][x] = ((x * 7 + y * 11) % 16) / 16.0;
                    }
                }
                return matrix;
            }

            loadPhotos() {
                // Using in-memory storage instead of localStorage for this artifact
                this.photos = this.photos || [];
            }

            savePhotos() {
                // In-memory storage - photos will persist during the session
                // This prevents localStorage issues in the artifact environment
            }

            async init() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 320 },
                            height: { ideal: 240 },
                            facingMode: 'user'
                        } 
                    });
                    this.video.srcObject = stream;
                    
                    this.video.addEventListener('loadedmetadata', () => {
                        this.setupCanvas();
                        this.startPreview();
                    });
                    
                    this.setupEventListeners();
                    this.updatePhotoCount();
                } catch (error) {
                    console.error('Camera access error:', error);
                    document.querySelector('.viewfinder').innerHTML = 
                        '<div style="color: #306230; text-align: center; padding: 20px;">CAMERA NOT AVAILABLE</div>';
                }
            }

            setupCanvas() {
                // Set both canvases with Game Boy resolution (160x144)
                this.previewCanvas.width = 160;
                this.previewCanvas.height = 144;
                this.canvas.width = 160;
                this.canvas.height = 144;
                
                // Disable anti-aliasing for pixelated effect
                this.previewCtx.imageSmoothingEnabled = false;
                this.ctx.imageSmoothingEnabled = false;
            }

            startPreview() {
                const updatePreview = () => {
                    if (this.video.readyState >= 2) {
                        // Draw video to preview canvas with Game Boy resolution
                        this.previewCtx.drawImage(this.video, 0, 0, 160, 144);
                        
                        // Apply stable Game Boy effect for preview
                        this.applyGameBoyEffectStable(this.previewCtx, 160, 144);
                    }
                    this.animationId = requestAnimationFrame(updatePreview);
                };
                updatePreview();
            }

            setupEventListeners() {
                document.getElementById('capture-btn').addEventListener('click', () => this.capturePhoto());
                document.getElementById('gallery-btn').addEventListener('click', () => this.showGallery());
                document.getElementById('close-gallery').addEventListener('click', () => this.hideGallery());
                document.getElementById('clear-gallery').addEventListener('click', () => this.showConfirmDialog());
                document.getElementById('confirm-cancel').addEventListener('click', () => this.hideConfirmDialog());
                document.getElementById('confirm-delete').addEventListener('click', () => this.clearGallery());

                // Filter controls
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelector('.filter-btn.active').classList.remove('active');
                        e.target.classList.add('active');
                        this.currentFilter = e.target.dataset.filter;
                    });
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space' || e.code === 'Enter') {
                        e.preventDefault();
                        this.capturePhoto();
                    }
                });
            }

            capturePhoto() {
                // Flash effect
                document.querySelector('.screen').style.background = '#0F380F';
                setTimeout(() => {
                    document.querySelector('.screen').style.background = '#9BBC0F';
                }, 100);

                // Draw current frame to capture canvas
                this.ctx.drawImage(this.video, 0, 0, 160, 144);
                
                // Apply high-quality Game Boy effect with Floyd-Steinberg dithering
                this.applyGameBoyEffectHighQuality(this.ctx, 160, 144);
                
                // Convert to data URL and save
                const dataURL = this.canvas.toDataURL('image/png');
                const timestamp = new Date().toISOString();
                
                this.photos.unshift({
                    id: Date.now(),
                    data: dataURL,
                    timestamp: timestamp,
                    filter: this.currentFilter
                });
                
                // Keep only the last 30 photos
                if (this.photos.length > 30) {
                    this.photos = this.photos.slice(0, 30);
                }
                
                this.savePhotos();
                this.updatePhotoCount();
            }

            applyGameBoyEffectStable(context, width, height) {
                const imageData = context.getImageData(0, 0, width, height);
                const data = imageData.data;
                
                // Game Boy color palette
                const palette = [
                    [15, 56, 15],    // Darkest green #0F380F
                    [48, 98, 48],    // Dark green #306230
                    [139, 172, 15],  // Light green #8BAC0F
                    [155, 188, 15]   // Lightest green #9BBC0F
                ];

                // Apply filter effects first
                this.applyFilterEffect(data, width, height);
                
                // Use stable ordered dithering for preview
                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const i = (y * width + x) * 4;
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        
                        // Convert to grayscale
                        const gray = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
                        
                        // Apply stable dithering using pre-computed matrix
                        const threshold = this.ditherMatrix[y][x] * 64 - 32;
                        const ditheredGray = Math.max(0, Math.min(255, gray + threshold));
                        
                        // Quantize to 4 levels
                        const paletteIndex = this.findClosestPaletteIndex(ditheredGray);
                        
                        // Set new pixel color
                        const color = palette[paletteIndex];
                        data[i] = color[0];
                        data[i + 1] = color[1];
                        data[i + 2] = color[2];
                    }
                }
                
                context.putImageData(imageData, 0, 0);
            }

            applyGameBoyEffectHighQuality(context, width, height) {
                const imageData = context.getImageData(0, 0, width, height);
                const data = imageData.data;
                
                // Game Boy color palette
                const palette = [
                    [15, 56, 15],    // Darkest green #0F380F
                    [48, 98, 48],    // Dark green #306230
                    [139, 172, 15],  // Light green #8BAC0F
                    [155, 188, 15]   // Lightest green #9BBC0F
                ];

                // Apply filter effects first
                this.applyFilterEffect(data, width, height);
                
                // Apply Floyd-Steinberg dithering for saved photos
                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const i = (y * width + x) * 4;
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        
                        // Convert to grayscale
                        const gray = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
                        
                        // Apply Floyd-Steinberg dithering
                        const oldPixel = gray;
                        const newPixel = this.findClosestPaletteIndex(oldPixel);
                        const quantError = oldPixel - (newPixel * 85); // 85 = 255/3 for 4 levels
                        
                        // Set new pixel color
                        const color = palette[newPixel];
                        data[i] = color[0];
                        data[i + 1] = color[1];
                        data[i + 2] = color[2];
                        
                        // Distribute error to neighboring pixels
                        if (x < width - 1) {
                            this.addError(data, width, x + 1, y, quantError * 7 / 16);
                        }
                        if (y < height - 1) {
                            if (x > 0) {
                                this.addError(data, width, x - 1, y + 1, quantError * 3 / 16);
                            }
                            this.addError(data, width, x, y + 1, quantError * 5 / 16);
                            if (x < width - 1) {
                                this.addError(data, width, x + 1, y + 1, quantError * 1 / 16);
                            }
                        }
                    }
                }
                
                context.putImageData(imageData, 0, 0);
            }

            applyFilterEffect(data, width, height) {
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    switch (this.currentFilter) {
                        case 'contrast':
                            const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                            const enhanced = gray > 128 ? Math.min(255, gray * 1.5) : Math.max(0, gray * 0.5);
                            data[i] = data[i + 1] = data[i + 2] = enhanced;
                            break;
                            
                        case 'invert':
                            data[i] = 255 - r;
                            data[i + 1] = 255 - g;
                            data[i + 2] = 255 - b;
                            break;
                            
                        case 'blur':
                            const avgGray = (r + g + b) / 3;
                            const noise = (Math.random() - 0.5) * 20;
                            const blurred = Math.max(0, Math.min(255, avgGray + noise));
                            data[i] = data[i + 1] = data[i + 2] = blurred;
                            break;
                            
                        default: // normal
                            const normalGray = 0.299 * r + 0.587 * g + 0.114 * b;
                            data[i] = data[i + 1] = data[i + 2] = normalGray;
                            break;
                    }
                }
            }

            findClosestPaletteIndex(gray) {
                // Map grayscale to 4-level palette
                if (gray < 64) return 0;       // Darkest
                else if (gray < 128) return 1; // Dark
                else if (gray < 192) return 2; // Light
                else return 3;                 // Lightest
            }

            addError(data, width, x, y, error) {
                const i = (y * width + x) * 4;
                if (i >= 0 && i < data.length) {
                    const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                    const newGray = Math.max(0, Math.min(255, gray + error));
                    data[i] = data[i + 1] = data[i + 2] = newGray;
                }
            }

            showGallery() {
                const gallery = document.getElementById('gallery');
                const grid = document.getElementById('gallery-grid');
                
                grid.innerHTML = '';
                
                this.photos.forEach(photo => {
                    const photoDiv = document.createElement('div');
                    photoDiv.className = 'gallery-photo';
                    photoDiv.innerHTML = `<img src="${photo.data}" alt="Game Boy Photo">`;
                    photoDiv.addEventListener('click', () => this.downloadPhoto(photo));
                    grid.appendChild(photoDiv);
                });
                
                if (this.photos.length === 0) {
                    grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #9BBC0F; padding: 40px;">NO PHOTOS SAVED</div>';
                }
                
                gallery.style.display = 'block';
            }

            hideGallery() {
                document.getElementById('gallery').style.display = 'none';
            }

            showConfirmDialog() {
                document.getElementById('confirm-dialog').style.display = 'block';
            }

            hideConfirmDialog() {
                document.getElementById('confirm-dialog').style.display = 'none';
            }

            clearGallery() {
                this.photos = [];
                this.savePhotos();
                this.updatePhotoCount();
                this.hideConfirmDialog();
                this.showGallery(); // Reload empty gallery
            }

            downloadPhoto(photo) {
                const a = document.createElement('a');
                a.href = photo.data;
                a.download = `gameboy-photo-${photo.id}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }

            updatePhotoCount() {
                document.getElementById('photo-count').textContent = 
                    this.photos.length.toString().padStart(3, '0');
            }
        }

        // Initialize when page is loaded
        window.addEventListener('load', () => {
            new GameBoyCamera();
        });

        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4ge30pOw==');
        }
    </script>
</body>
</html>